<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>On Top Of Things</title>
	<link rel="stylesheet" href="base.css">
	<script src="bower_components/jquery/dist/jquery.js"></script>
	<script src="bower_components/react/react-with-addons.js"></script>
	<script src="bower_components/react/JSXTransformer.js"></script>
	<script src="bower_components/director/build/director.js"></script>
	<script src="bower_components/underscore/underscore.js"></script>
	<link rel="stylesheet" href="style.css">
</head>
<body>
<section id="app"></section>
<div id="test"></div>

<script type="text/jsx">
var horizon_l = ["new", "today", "next", "week", "month", "quarter", "year"];

function createComparor(criterion_l) {
	return function(a, b) {
		//console.log("criterion_l: "+criterion_l);
		for (var i = 0; i < criterion_l.length; i++) {
			var criterion = criterion_l[i];
			//console.log("criterion: "+criterion);
			if (criterion == "created") {
				var n = a.created.localeCompare(b.created);
				if (n != 0) {
					return n;
				}
			}
			else if (criterion == "folder") {
				if (!_.isEqual(a.folder, b.folder)) {
					return (a.folder < b.folder) ? -1 : 1;
				}
			}
			else if (criterion == "horizon") {
				var ia = horizon_l.indexOf(a.horizon);
				var ib = horizon_l.indexOf(b.horizon);
				//console.log(a.horizon+"="+ia+", "+b.horizon+"="+ib);
				if (ia != ib) {
					return (ia < ib) ? -1 : 1;
				}
			}
		}
		return 0;
	}
}

var TaskItem = React.createClass({
	getInitialState: function() {
		return {item: {}};
	},
	componentDidMount: function() {
		var state1 = {};
		if (this.props.item)
			state1.item = this.props.item;
		if (this.props.index)
			state1.index = this.props.index;
		this.setState(state1);
	},
	render: function() {
		var item = this.state.item;
		var folderElem = (!item.folder || this.props['hide-folder']) ? <span/> : <span> /{item.folder.join("/")}: </span>;
		var horizonElem = (!item.horizon || this.props['hide-horizon'])
			? <span/>
			: <span className='field-horizon'> ?{item.horizon} </span>;
		var indexElem = (this.state.index)
			? <span className='index'>{this.state.index}</span>
			: <span/>
		var checkboxElem = (item.closed)
			? <input type='checkbox' className='checkbox-closed' checked/>
			: <input type='checkbox' className='checkbox-closed'/>
		var tagElem = (!_.isEmpty(item.tag))
			? <span> (+{item.tag.join(",+")}) </span>
			: <span/>;
		var itemStyle = (item.deleted) ? {'text-decoration': 'line-through', "color": "#808080"} : {};
		return (
			<li className='task' key={item.id}>
				<span style={itemStyle}>
					{indexElem}
					{checkboxElem}
					{folderElem}
					{horizonElem}
					{item.title}
					{tagElem}
				</span>
			</li>
		);
	}
});

var TaskList = React.createClass({
	fetchItemsFromServer: function() {
		console.log("fetchItemsFromServer()");
		var archived = "";
		//if ($("#rdoArchived").prop("checked"))
			//archived = "&archived=true";
		//else if ($("#rdoArchivedOnly").prop("checked"))
			//archived = "&archived=only";
		$.ajax({
			url: "/items?wrapper=items"+archived,
			dataType: 'json',
			success: function(snapshot) {
				var criterion_l = this.state.headers.concat(this.state.order);
				var comparor = createComparor(criterion_l);
				var items = snapshot.items;
				items.sort(comparor);
				this.setState({items: items});
			}.bind(this),
			error: function(xhr, status, err) {
				console.error(status, err.toString());
			}.bind(this)
		});
	},
	getInitialState: function() {
		return {
			items: [],
			headers: ["folder"],
			order: ["horizon", "created"]
		};
	},
	componentDidMount: function() {
		console.log("componentDidMount()");
		this.fetchItemsFromServer();
	},
	render: function() {
		console.log("render()");
		var itemElems = this.state.items.map(function(item) {
			return <TaskItem item={item}/>;
		});
		var header_l = this.state.headers;
		var header0 = [];
		var itemElems = [];
		var index = 1;
		var hideFolder = (header_l.indexOf("folder") >= 0);
		var hideHorizon = (header_l.indexOf("horizon") >= 0);
		for (var i in this.state.items) {
			var item = this.state.items[i];
			for (var j = 0; j < header_l.length; j++) {
				var fieldName = header_l[j];
				var fieldValue = item[fieldName];
				if (fieldName === "folder") {
					fieldValue = "/"+(fieldValue || []).join("/");
				}
				//console.log("j = "+j+", fieldName = "+fieldName+", header[j] = "+header[j]
				// +", header0[j] = "+header0[j]);
				if (!_.isEqual(fieldValue, header0[j])) {
					header0[j] = fieldValue;
					var headerClass = "task-header-"+(j+1)+" field-"+fieldName;
					var headerKey = _(header0).first(j + 1).join("|");
					itemElems.push(
						<li className={headerClass} key={headerKey}>
							<label>{fieldValue}</label>
						</li>
					);
				}
			}
			itemElems.push(<TaskItem item={item} index={index} hide-folder={hideFolder} hide-horizon={hideHorizon}/>);
			index++;
		}

		return (
			<ul className="task-list">
			{itemElems}
			</ul>
		);
	}
});

/*var item0 = { "folder": ['one', 'two'], horizon: 'week', tag: ['mustdo'], title: 'rock around the clock' };

React.render(
	<TaskItem item={item0}/>,
	document.getElementById("test")
);
*/
React.render(
	<TaskList/>,
	document.getElementById("test")
);
</script>
</body>
</html>

